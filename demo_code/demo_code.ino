#include <OctoWS2811.h>
#include <Audio.h>
#include <Wire.h>
#include <SD.h>
#include <SPI.h>

#define LIGHTING 0
#define COLOR 1
#define RANDOM 2
#define PLASMA 3

//Color Temp to RGB lookup table generated from data available at http://www.tannerhelland.com/4435/convert-temperature-rgb-algorithm-code/
const unsigned char r_k[] = {255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 254, 252, 249, 247, 245, 243, 240, 239, 237, 235, 233, 231, 230, 228, 227, 225, 224, 222, 221, 220, 218, 217, 216, 215, 214, 212, 211, 210, 209, 208, 207, 207, 206, 205, 204, 203, 202, 201, 201, 200, 199, 199, 198, 197, 196, 196, 195, 195, 194, 193, 193, 192, 192, 191, 191, 190, 190, 189, 189, 188, 188, 187, 187, 186, 186, 185, 185, 185, 184, 184, 183, 183, 183, 182, 182, 182, 181, 181, 181, 180, 180, 180, 179, 179, 179, 178, 178, 178, 178, 177, 177, 177, 177, 176, 176, 176, 175, 175, 175, 175, 175, 174, 174, 174, 174, 173, 173, 173, 173, 173, 172, 172, 172, 172, 172, 171, 171, 171, 171, 171, 170, 170, 170, 170, 170, 170, 169, 169, 169, 169, 169, 169, 169, 168, 168, 168, 168, 168, 168, 168, 167, 167, 167, 167, 167, 167, 167, 166, 166, 166, 166, 166, 166, 166, 166, 165, 165, 165, 165, 165, 165, 165, 165, 165, 164, 164, 164, 164, 164, 164, 164, 164, 164, 164, 163, 163, 163, 163, 163, 163, 163, 163, 163, 163, 163, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 162, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 161, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155};
const unsigned char g_k[] = {56, 71, 83, 93, 101, 109, 115, 121, 126, 131, 137, 142, 147, 152, 157, 161, 165, 169, 173, 177, 180, 184, 187, 190, 193, 196, 199, 201, 204, 206, 209, 211, 213, 215, 217, 219, 221, 223, 225, 227, 228, 230, 232, 233, 235, 236, 238, 239, 240, 242, 243, 244, 245, 246, 248, 249, 249, 247, 246, 245, 243, 242, 241, 240, 239, 238, 237, 236, 235, 234, 233, 232, 231, 230, 230, 229, 228, 227, 227, 226, 225, 225, 224, 223, 223, 222, 221, 221, 220, 220, 219, 219, 218, 218, 217, 217, 216, 216, 216, 215, 215, 214, 214, 214, 213, 213, 212, 212, 212, 211, 211, 211, 210, 210, 210, 210, 209, 209, 209, 208, 208, 208, 208, 207, 207, 207, 207, 206, 206, 206, 206, 205, 205, 205, 205, 205, 204, 204, 204, 204, 204, 203, 203, 203, 203, 203, 202, 202, 202, 202, 202, 202, 201, 201, 201, 201, 201, 201, 201, 200, 200, 200, 200, 200, 200, 200, 199, 199, 199, 199, 199, 199, 199, 199, 198, 198, 198, 198, 198, 198, 198, 198, 198, 197, 197, 197, 197, 197, 197, 197, 197, 197, 197, 196, 196, 196, 196, 196, 196, 196, 196, 196, 196, 196, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 195, 194, 194, 194, 194, 194, 194, 194, 194, 194, 194, 194, 194, 194, 194, 194, 193, 193, 193, 193, 193, 193, 193, 193, 193, 193, 193, 193, 193, 193, 193, 193, 193, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 191, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 190, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 189, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188, 188};
const unsigned char b_k[] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18, 33, 44, 54, 63, 72, 79, 87, 94, 101, 107, 114, 120, 126, 132, 137, 143, 148, 153, 159, 163, 168, 173, 177, 182, 186, 190, 194, 198, 202, 206, 210, 213, 217, 220, 224, 227, 230, 233, 236, 239, 242, 245, 248, 251, 253, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255};
unsigned char gamma_lookup[256];

const int leds_per_pin = 120;
DMAMEM int display_memory[leds_per_pin * 6];
int drawing_memory[leds_per_pin * 6];
const int config = WS2811_GRB | WS2811_800kHz;
OctoWS2811 leds(leds_per_pin, display_memory, drawing_memory, config);
String serial_input = "";
boolean new_command = false;
unsigned int color_temp = 10000;
unsigned int rgb_r = 0;
unsigned int rgb_g = 0;
unsigned int rgb_b = 0;
unsigned int bright = 0;
float gam = 2.5;
char buf[10];
unsigned int mode = LIGHTING;

void setup()
{
  set_gamma(gam);
  leds.begin();
  //Serial1.begin(9600);
  Serial.begin(115200);
  serial_input.reserve(50);
  Serial.println("Demo Mode");
}

void loop()
{
  Serial.println("Sweeping Color Temperature");
  for(unsigned int k = 1000; k < 40000; k+= 10)
  {
    set_color_temp(k, 35);
    if (k % 1000 == 0)
    {
      Serial.print("Color temp: ");
      Serial.print(k);
      Serial.println("K");
    }
  }
  Serial.println("RGB Colors");
  for (unsigned int i = 0; i < 10; i++)
  {
    unsigned int r_t = random(0, 255);
    unsigned int g_t = random(0, 255);
    unsigned int b_t = random(0, 255);
    set_color(r_t, g_t, b_t, 35);
    Serial.print("R: ");
    Serial.print(r_t);
    Serial.print(", G: ");
    Serial.print(g_t);
    Serial.print(", B: ");
    Serial.println(b_t);
    delay(1000);
  }
  Serial.println("Random pattern");
  for (unsigned int i = 0; i < 1000; i++)
  {
    set_random(50);
  }
  Serial.println("Plasma pattern");
  for (unsigned int i = 0; i < 20; i++)
  {
    plasma(30);
  }
}

void set_color_temp(unsigned int k, unsigned int brightness)
{
  if (k > 999 && k < 40001 && brightness < 101)
  {
      k -= 1000;
      k /= 100;
      unsigned int corr = ((unsigned int) r_k[k]) * brightness;
      unsigned int corg = ((unsigned int) g_k[k]) * brightness;
      unsigned int corb = ((unsigned int) b_k[k]) * brightness;
      corr /= 100;
      corg /= 100;
      corb /= 100;
      corr = min(corr, 255);
      corg = min(corg, 255);
      corb = min(corb, 255);
      corr = gamma_lookup[corr];
      corg = gamma_lookup[corg];
      corb = gamma_lookup[corb];
      for (unsigned int i = 0; i < 8 * leds_per_pin; i++)
      {
        leds.setPixel(i, corr, corg, corb);
      }
  }
  leds.show();
}

void set_gamma(float g) //Generate a gamma correction lookup table (quanitization sucks)
{
  for (unsigned int i = 0; i < 256; i++)
  {
      gamma_lookup[i] = (unsigned char) (pow((float)i / (float)255, g) * 255 + 0.5);
  }
}

void set_color(unsigned int r, unsigned int g, unsigned int b, unsigned int brightness)
{
  r *= brightness;
  g *= brightness;
  b *= brightness;
  r /= 100;
  g /= 100;
  b /= 100;
  r = min(r, 255);
  g = min(g, 255);
  b = min(b, 255);
  r = gamma_lookup[r];
  g = gamma_lookup[g];
  b = gamma_lookup[b];
  for (unsigned int i = 0; i < 8 * leds_per_pin; i++)
  {
    leds.setPixel(i, r, g, b);
  }
  leds.show();
}

void set_random(unsigned int brightness)
{
  brightness = (unsigned int) (((float) brightness) * 2.55f);
  for (unsigned int i = 0; i < 8 * leds_per_pin; i++)
  {
    leds.setPixel(i, gamma_lookup[random(0, brightness)], gamma_lookup[random(0, brightness)], gamma_lookup[random(0, brightness)]);
    //leds.setPixel(i, random(0, brightness), random(0, brightness), random(0, brightness));
  }
  leds.show();
}

float dist(unsigned int x, unsigned int y)
{
  return sqrt((x-6)*(x-6)+(y-5)*(y-5));
}

void plasma(unsigned int brightness)
{
  int rp = 0;
  int gp = 0;
  int bp = 0;
  unsigned int i;
  for (float t = 0; t < 6.25; t+= 0.25)
  {
    for (unsigned int x = 0; x < 12; x++)
    {
      for (unsigned int y = 0; y < 10; y++)
      {
        rp = 64 * (-sin(x + t) + sin(y - t) - sin(x + y + t) + sin(dist(x, y) - t)) + 255;
        gp = 64 * (sin(x - t) - sin(y + t) + sin(x + y - t) - sin(dist(x, y) + t)) + 255;
        bp = 64 * (sin(x + t) + sin(y + t) + sin(x + y + t) + sin(dist(x, y) + t)) + 255;
        rp *= brightness;
        rp /= 100;
        gp *= brightness;
        gp /= 100;
        bp *= brightness;
        bp /= 100;
        rp = max(min(rp, 255), 0);
        gp = max(min(gp, 255), 0);
        bp = max(min(bp, 255), 0);
        i = x + (12 * y) + 240;
        leds.setPixel(i, gamma_lookup[rp], gamma_lookup[gp], gamma_lookup[bp]);
      }
    }
    while(leds.busy());
    leds.show();
  }
}
